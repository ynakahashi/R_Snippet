---
title: "BayesianNetwork"
author: "Y.Nakahashi"
date: "2018/1/10"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### 目的
*Bayesian Network*により変数間の関連性を図示し，かつその強さを定量的に示したい．

----

### 分析環境の準備
#### ライブラリの読み込み

```{r}
suppstrsMessages(library(BNSL))
suppstrsMessages(library(bnlearn))
```

#### サンプルデータの作成
HeightとSBPがBMIに刺さり，BMIがFBSに刺さる構造とする．

```{r}
norm <- rnorm(4000)
Data <- matrix(norm, nrow = 1000, ncol = 4, byrow = T)
colnames(Data) <- c("Height", "BMI", "SBP", "FBS")

Data2 <- Data <- as.data.frame(Data)
Data2$Height <- 170 + Data$Height * 10
Data2$SBP    <- 120 + Data$SBP * 10
Data2$BMI    <- 22  + Data$Height * 2 + Data$SBP * 2
Data2$FBS    <- 90  + (Data2$BMI - 22) * 5 + Data$FBS * 10
formattable::formattable(head(Data2))
```


### 分析実行
#### 構造学習
構造学習のアルゴリズムには*Grow-Shrink*を指定．Webだと*Hill-Climbing*が使われる事が多い様子．*gs*ではその通りに構造を学習できている．

```{r}
str_01 <- gs(Data2)
plot(str_01)
```

#### フィッティング
この構造を用いてパラメータを推定する．ここで得られる係数は，個別にlmをかけたものと同じとなる．例えばBMIであれば，lm(BMI ~ Height + SBP)と等しい．

```{r}
fit_01 <- bn.fit(str_01, Data2)
(coef_01 <- coefficients(fit_01))
```

```{r}
coef(lm(BMI ~ Height + SBP, Data2))
```



### 分析実行その２
#### 構造学習
サンプルデータの*gaussian.test*を用いてパラメータの推定を行う．元の構造はわからないが*gs*によって推定した形は以下のよう．

```{r}
str_02 <- gs(gaussian.test)
plot(str_02)
```

#### フィッティング
グラフの構造が悪く，フィッティングできない．

```{r}
fit_02 <- bn.fit(str_02, gaussian.test)
```

str_02の中身を確認すると，modelが[partially directed graph]となっていることがわかる．またarcsのundirected arcsが1になっている．

```{r}
str_02
```

再度str_02の構造を確認すると，ノードBD間のエッジが無向になっていることがわかる．

```{r}
plot(str_02)
```


そこでB -> Dのエッジを設定してみる．undirected arcsが0となり，modelがpartially directed graphではなくノード間の関連性を表したものとなっていることを確認する．

```{r}
(str_03 <- set.arc(str_02, "B", "D"))
plot(str_03)
```

この構造を用いて再度フィッティングしてみる．

```{r}
fit_03 <- bn.fit(str_03, gaussian.test)
(coef_03 <- coefficients(fit_03))
```

今度は上手くいった！

### 分析実行その３
#### 構造学習
今度は構造の推定に*BNSL*を試してみる．

```{r}
str_04 <- bnsl(gaussian.test)
plot(str_04)
```

bnlearn::gsを用いた時と比べて構造がかなり異なる．比較してみる．

```{r}
par(mfrow = c(1, 2))
plot(str_03) # bnlearn::gsで推定したあとにset.arcでB -> Dを設定
plot(str_04) # BNSL::bnsl
```

"A -> C"や"G -> F"など，方向性が逆転する関係が見られる．Eも独立してしまった．

#### フィッティング
この構造でフィッティングしてみる．フィッティング自体はbnlearn::bn.fitを用いる．

```{r}
fit_04 <- bn.fit(str_04, gaussian.test)
coefficients(fit_04)
```

### 分析実行その４
さらに続いて，データを標準化した場合の結果も確認してみる．*scale*でデータを標準化する．

```{r}
my_gaussian <- as.data.frame(scale(gaussian.test))
str_05 <- bnsl(my_gaussian)
par(mfrow = c(1, 3))
plot(str_03)
plot(str_04)
plot(str_05)
```

標準化すると構造が変わってしまう．

```{r}
fit_05 <- bn.fit(str_05, my_gaussian)
coefficients(fit_05)
```



```{r}
str_06 <- gs(learning.test)
str_07 <- gs(learning.test, optimized = TRUE)
par(mfrow = c(1, 2))
plot(str_06)
plot(str_07)
```

```{r}
str_08 <- set.arc(str_06, "A", "B")
bn.fit(str_08, learning.test, method = "mle")
bn.fit(str_08, learning.test, method = "bayes")
```




