---
title: "BayesianNetwork"
author: "Y.Nakahashi"
date: "2018/1/10"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### 目的
*Bayesian Network*により変数間の関連性を図示し，かつその強さを定量的に示したい．

### 分析環境の準備
#### ライブラリの読み込み
*bnlearn*だとうまくfitできないので，*BNSL*を使う．

```{r}
suppstrsMessages(library(BNSL))
suppstrsMessages(library(bnlearn))
```

#### サンプルデータの作成
HeightとSBPがBMIに刺さり，BMIがFBSに刺さる構造とする．

```{r}
norm <- rnorm(4000)
Data <- matrix(norm, nrow = 1000, ncol = 4, byrow = T)
colnames(Data) <- c("Height", "BMI", "SBP", "FBS")

Data2 <- Data <- as.data.frame(Data)
Data2$Height <- 170 + Data$Height * 10
Data2$SBP    <- 120 + Data$SBP * 10
Data2$BMI    <- 22  + Data$Height * 2 + Data$SBP * 2
Data2$FBS    <- 90  + (Data2$BMI - 22) * 5 + Data$FBS * 10
formattable::formattable(head(Data2))
```


### 分析実行
#### 構造学習
構造学習のアルゴリズムには*Grow-Shrink*を指定．Webだと*Hill-Climbing*が使われる事が多い様子．*gs*ではその通りに構造を学習できている．

```{r}
str_01 <- gs(Data2)
plot(str_01)
```

#### フィッティング
この構造を用いてパラメータを推定する．係数の意味はよくわからない．

```{r}
fit_01 <- bn.fit(str_01, Data2)
(Coef <- coefficients(fitted))
```


### 分析実行その２
サンプルデータの*gaussian.test*を用いてパラメータの推定を行う．

#### 構造学習
元の構造はわからないが，*gs*によって推定した形は以下のよう．

```{r}
str_02 <- gs(gaussian.test)
plot(str_02)
```

#### フィッティング
グラフの構造が悪く，フィッティングできない．

```{r}
str_02
```






```{r}
fit_02 <- bn.fit(str_02, gaussian.test)
```

無向のエッジがあるためかと考え，B -> Dのエッジを設定する．undirected arcsが0となっていることを確認．

```{r}
(str_03 <- set.arc(str_02, "B", "D"))
```

フィッティングしたが，やはりダメ．

```{r}
fit_03 <- bn.fit(str_03, gaussian.test)

```

### 分析実行その３
#### 構造学習
今度は構造の推定に*BNSL*を試してみる．

```{r}
str_04 <- bnsl(gaussian.test)
plot(str_04)
```

bnlearn::gsを用いた時と比べて構造がかなり異なる．比較してみる．

```{r}
par(mfrow = c(1, 2))
plot(str_03) # bnlearn::gsで推定したあとにset.archでB -> Dを設定
plot(str_04) # BNSL::bnsl
```

"A -> C"や"G -> F"など，方向性が逆転する関係が見られる．Eも独立してしまった．

#### フィッティング
この構造でフィッティングしてみる．フィッティング自体はbnlearn::bn.fitを用いる．

```{r}
fit_03 <- bn.fit(str_03, gaussian.test)
coefficients(fit_03)
```

```{r}
tmp <- as.data.frame(scale(gaussian.test))
str_22 <- bnsl(tmp)
plot(str_22)

fit_02 <- bn.fit(str_22, tmp)
coefficients(fit_02)
```



```{r}
str_01_arc <- set.arc(str_01, "C", "F")
plot(str_01)
plot(str_01_arc)
bn.fit(str_01_arc, gaussian.test)



str_02 <- gs(gaussian.test, optimized = TRUE)
plot(str_02)
identical(str_01, str_02)

bn.fit(str_02, gaussian.test)
arc.strength(str_02, gaussian.test)



str_11 <- gs(learning.test)
plot(str_11)
str_12 <- gs(learning.test, optimized = TRUE)
plot(str_12)
bn.fit(str_12, learning.test)
```




